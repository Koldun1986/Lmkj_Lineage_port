From 36859ef0887ac383e448da0207c45f119bf288a2 Mon Sep 17 00:00:00 2001
From: vgdn1942 <vgdn1942@gmail.com>
Date: Sun, 15 Oct 2017 15:30:21 +0300
Subject: [PATCH] Change audio out for MTK FmRadio (3/3)

Change-Id: Ib6566ec01cba6d733d9c6d38f33579f1d750b0d9
---
 services/audiopolicy/AudioPolicyManager.cpp | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/services/audiopolicy/AudioPolicyManager.cpp b/services/audiopolicy/AudioPolicyManager.cpp
index 50d4cc2..f6c37ea 100644
--- a/services/audiopolicy/AudioPolicyManager.cpp
+++ b/services/audiopolicy/AudioPolicyManager.cpp
@@ -68,7 +68,7 @@
 #ifdef AUDIO_EXTN_FM_ENABLED
 #define APM_AUDIO_IN_DEVICE_VIRTUAL_ALL  (AUDIO_DEVICE_IN_REMOTE_SUBMIX | AUDIO_DEVICE_IN_FM_RX_A2DP)
 #else
-#define APM_AUDIO_IN_DEVICE_VIRTUAL_ALL  (AUDIO_DEVICE_IN_REMOTE_SUBMIX|AUDIO_DEVICE_IN_FM_TUNER)
+#define APM_AUDIO_IN_DEVICE_VIRTUAL_ALL  (AUDIO_DEVICE_IN_REMOTE_SUBMIX | AUDIO_DEVICE_IN_FM_TUNER)
 #endif
 
 // A device mask for all audio output devices that are considered "remote" when evaluating
@@ -149,7 +149,7 @@ const StringToEnum sDeviceNameToEnumTable[] = {
 #ifdef AUDIO_EXTN_AFE_PROXY_ENABLED
     STRING_TO_ENUM(AUDIO_DEVICE_OUT_PROXY),
 #endif
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
     STRING_TO_ENUM(AUDIO_DEVICE_OUT_FM_TX),
 #endif
     STRING_TO_ENUM(AUDIO_DEVICE_IN_BUILTIN_MIC),
@@ -529,7 +529,7 @@ status_t AudioPolicyManager::setDeviceConnectionStateInt(audio_devices_t device,
             updateCallRouting(newDevice);
         }
 
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
         if(device == AUDIO_DEVICE_OUT_FM) {
             if (state == AUDIO_POLICY_DEVICE_STATE_AVAILABLE) {
                 mOutputs.valueFor(mPrimaryOutput)->changeRefCount(AUDIO_STREAM_MUSIC, 1);
@@ -1164,7 +1164,7 @@ void AudioPolicyManager::setForceUse(audio_policy_force_use_t usage,
         break;
     case AUDIO_POLICY_FORCE_FOR_MEDIA:
         if (config != AUDIO_POLICY_FORCE_HEADPHONES && config != AUDIO_POLICY_FORCE_BT_A2DP &&
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
             config != AUDIO_POLICY_FORCE_SPEAKER &&
 #endif
             config != AUDIO_POLICY_FORCE_WIRED_ACCESSORY &&
@@ -2698,7 +2698,7 @@ status_t AudioPolicyManager::setStreamVolumeIndex(audio_stream_type_t stream,
         audio_devices_t curDevice =
                 getDeviceForVolume(mOutputs.valueAt(i)->device());
 
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
         audio_devices_t availableOutputDeviceTypes = mAvailableOutputDevices.types();
         if (((device == AUDIO_DEVICE_OUT_DEFAULT) &&
               ((availableOutputDeviceTypes & AUDIO_DEVICE_OUT_FM) != AUDIO_DEVICE_OUT_FM)) ||
@@ -5710,7 +5710,7 @@ audio_devices_t AudioPolicyManager::getDeviceForStrategy(routing_strategy strate
             break;
         }
 
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
         if (availableOutputDeviceTypes & AUDIO_DEVICE_OUT_FM) {
             if (mForceUse[AUDIO_POLICY_FORCE_FOR_MEDIA] == AUDIO_POLICY_FORCE_SPEAKER) {
                 device = AUDIO_DEVICE_OUT_SPEAKER;
@@ -5771,7 +5771,7 @@ audio_devices_t AudioPolicyManager::getDeviceForStrategy(routing_strategy strate
             device = getDeviceForStrategy(STRATEGY_PHONE, false /*fromCache*/);
             break;
         }
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
         if (mForceUse[AUDIO_POLICY_FORCE_FOR_MEDIA] == AUDIO_POLICY_FORCE_SPEAKER) {
             device = AUDIO_DEVICE_OUT_SPEAKER;
             break;
@@ -5831,7 +5831,7 @@ audio_devices_t AudioPolicyManager::getDeviceForStrategy(routing_strategy strate
                 && (strategy != STRATEGY_SONIFICATION)) {
             device2 = availableOutputDeviceTypes & AUDIO_DEVICE_OUT_ANLG_DOCK_HEADSET;
         }
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
             if ((strategy != STRATEGY_SONIFICATION) && (device == AUDIO_DEVICE_NONE)
                  && (device2 == AUDIO_DEVICE_NONE)) {
                 device2 = availableOutputDeviceTypes & AUDIO_DEVICE_OUT_FM_TX;
@@ -6493,7 +6493,7 @@ AudioPolicyManager::device_category AudioPolicyManager::getDeviceCategory(audio_
         case AUDIO_DEVICE_OUT_BLUETOOTH_SCO_HEADSET:
         case AUDIO_DEVICE_OUT_BLUETOOTH_A2DP:
         case AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES:
-#ifdef AUDIO_EXTN_FM_ENABLED
+#if defined(AUDIO_EXTN_FM_ENABLED) || defined(MTK_HARDWARE)
         case AUDIO_DEVICE_OUT_FM:
 #endif
             return DEVICE_CATEGORY_HEADSET;
-- 
2.7.4

